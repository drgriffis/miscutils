#!/usr/bin/env bash

function usage {
cat << EOF
Joins multiple small split files into a single large file.
(works with files generated by splitfile script)

Usage: `basename $0` BASEFILE NUMSPLITS [OPTIONS]

Options:
    -l  the number of lines to include in each file (default 100k)
    -d  the directory to write file to (default current directory)
EOF
}

function progress {
echo -en "\rJoined $1 of $2 split files"
}

file=$1
nsplits=$2
OPTIND=$(( OPTIND + 2 ))

if [ -z "$file" ] || [ -z "$nsplits" ]; then
    usage
    exit
fi

destdir=.
while getopts "d:" OPTION; do
    case $OPTION in
        d)
            destdir=$OPTARG
            ;;
    esac
done
destpath=$destdir/`basename $file`

# if the joined file already exists, we want to overwrite it
if [ -e $destpath ]; then
    rm $destpath
fi

for i in $( seq 1 $nsplits ); do
    cat ${file}.${i} >> ${destpath}
    progress $i $nsplits
done
echo
